//- views/clientes/index.pug
extends ../layout/layout

block content
  .d-flex.justify-content-between.flex-wrap.flex-md-nowrap.align-items-center.pt-3.pb-2.mb-3.border-bottom
    .d-flex.align-items-center
      .me-3
        i.bi.bi-people-fill.fs-1.text-primary
      div
        h1.mb-0 Gestión de Clientes
        p.lead.mb-0.text-muted Administra tu cartera de clientes
    
    .btn-toolbar.mb-2.mb-md-0
      a.btn.btn-primary(href="/clientes/nuevo")
        i.bi.bi-plus-circle.me-2
        | Nuevo Cliente

  //- Filtros y búsqueda
  .card.mb-4
    .card-body
      .row
        .col-md-8
          .input-group
            input.form-control(type="text", placeholder="Buscar cliente...", id="searchInput")
            button.btn.btn-outline-primary(type="button", id="searchBtn")
              i.bi.bi-search.me-2
              | Buscar
        .col-md-4
          select.form-select#filterType
            option(value="all") Todos los tipos
            option(value="empresa") Empresas
            option(value="individual") Individuales

  //- Tabla de clientes
  .card
    .card-body
      if clientes && clientes.length > 0
        .table-responsive
          table.table.table-hover
            thead
              tr.encabezado-tabla
                th ID
                th Nombre
                th Empresa
                th Contacto
                th Tipo
                th Acciones
            tbody
              each cliente in clientes
                tr
                  td= cliente.id
                  td= cliente.nombre
                  td= cliente.empresa || 'Sin empresa'
                  td
                    div= cliente.email
                    small.text-muted= cliente.telefono || 'Sin teléfono'
                  td
                    span.badge(class=cliente.tipo === 'empresa' ? 'bg-primary' : 'bg-success')= cliente.tipo
                  td
                    .btn-group-group.btn-group-sm
                      a.btn.btn-sm.btn-outline-success(href=`/clientes/${cliente.id}`)
                        i.bi.bi-eye
                      a.btn.btn-sm.btn-outline-primary(href=`/clientes/editar/${cliente.id}`)
                        i.bi.bi-pencil
                      //- Arreglo clave: ID entre comillas
                      button.btn.btn-sm.btn-outline-danger(
                        type="button",
                        onclick=`confirmDelete('${cliente.id}')`
                      )
                        i.bi.bi-trash
      else
        .text-center.py-5
          i.bi.bi-people.fs-1.text-muted
          p.mt-3 No hay clientes registrados
          a.btn.btn-primary(href="/clientes/nuevo") Agregar primer cliente

  //- Toast de notificación (opcional, mejora visual)
  div#toastContainer.position-fixed.bottom-0.end-0.p-3(style="z-index: 1055")
    .toast(role="alert" aria-live="assertive" aria-atomic="true")
      .toast-header
        strong.me-auto Eventify
        small.text-muted Justo ahora
        button.btn-close(type="button", data-bs-dismiss="toast", aria-label="Cerrar")
      .toast-body#toastBody Cliente eliminado correctamente

block scripts
  script.
    // Muestra un toast Bootstrap (en lugar de alert)
    function showToast(message) {
      const toastBody = document.getElementById('toastBody');
      const toastEl = document.querySelector('.toast');
      if (toastBody) toastBody.textContent = message;
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }

    // Función para confirmar y eliminar
    function confirmDelete(id) {
      if (confirm('¿Estás seguro de eliminar este cliente?')) {
        fetch(`/clientes/${id}?_method=DELETE`, { method: 'POST' })
          .then(response => {
            if (response.redirected) {
              // Express redirige después de borrar
              window.location.href = response.url;
            } else {
              return response.json();
            }
          })
          .then(data => {
            if (data?.mensaje) {
              showToast(data.mensaje);
              setTimeout(() => location.reload(), 1200);
            }
          })
          .catch(error => console.error('Error:', error));
      }
    }


  //- Solo funciones específicas de clientes
  script.
    function confirmDelete(id) {
      if (confirm('¿Estás seguro de eliminar este cliente?')) {
        fetch(`/clientes/${id}?_method=DELETE`, { method: 'POST' })
          .then(response => {
            if (response.redirected) {
              window.location.href = response.url;
            }
          })
          .catch(error => console.error('Error:', error));
      }
    }
